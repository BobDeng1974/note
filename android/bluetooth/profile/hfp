//client
===============
//电话
waitForIndicators

updateCallSetupIndicator


//声音状态回调
audio_state_cb-->method_onAudioStateChanged@com_android_bluetooth_hfpclient.cpp-->
onAudioStateChanged{
- StackEvent event = new StackEvent(EVENT_TYPE_AUDIO_STATE_CHANGED)//AUDIO_STATE_DISCONNECTED 0 AUDIO_STATE_CONNECTED 2
- sendMessage(STACK_EVENT)
}@HeadsetClientStateMachine.java 


//Connected state
Connected.processMessage{
- ACCEPT_CALL-->acceptCall{ //acceptCall/rejectCall@HeadsetClientService.java
	- getCall(CALL_STATE_INCOMING|CALL_STATE_WAITING)//获取要处理的call
	- action =CALL_ACTION_ATA //设置对应的action
	- handleCallActionNative//发送命令，接听
	- 接听成功，addQueuedAction-->mQueuedActions.add(ACCEPT_CALL,action)//用于命令返回时处理
	}
- REJECT_CALL-->rejectCall
- STACK_EVENT{
	- EVENT_TYPE_CALL-->updateCallIndicator
	- EVENT_TYPE_CALLSETUP-->updateCallSetupIndicator
	- EVENT_TYPE_CALLHELD-->updateCallHeldIndicator
	- EVENT_TYPE_CMD_RESULT{//发送蓝牙命令后，返回结果
		- 获取发送过的命令数据，mQueuedActions.poll()
		- ACCEPT_CALL{
			- 接听成功，mPendingAction = queuedAction
			}
		}
	}
}




static{ classInitNative}//设置jni回调函数
{
onConnectionStateChanged
onAudioStateChanged
onCall-->sendMessage(EVENT_TYPE_CALL)
onCallSetup-->sendMessage(EVENT_TYPE_CALLSETUP)
}

HeadsetClientStateMachine{
- initializeNative //获取接口设置回调
- addState(mDisconnected)
- addState(mConnecting)
- addState(mConnected)
- addState(mAudioOn, mConnected)
- setInitialState(mDisconnected)
}@HeadsetClientStateMachine.java 

initializeNative{
- getBluetoothInterface
- sBluetoothHfpClientInterface =btInf->get_profile_interface(BT_PROFILE_HANDSFREE_CLIENT_ID)//hfpclient接口
- sBluetoothHfpClientInterface->init(&sBluetoothHfpClientCallbacks) //设置回调
}@com_android_bluetooth_hfpclient.cpp


packages/apps/Bluetooth/src/com/android/bluetooth/hfpclient/HeadsetClientService.java
packages/apps/Bluetooth/src/com/android/bluetooth/hfpclient/HeadsetClientStateMachine.java 
packages/apps/Bluetooth/jni/com_android_bluetooth_hfpclient.cpp


//=================
//stack

init-->bt_hf_client_callbacks = callbacks@btif_hf_client.c


//注册回调bte_hf_client_evt，到队列btu_bta_msg_queue
btif_hf_client_execute_service@btif_hf_client.c-->
BTA_HfClientEnable(bte_hf_client_evt){
- bta_sys_register(BTA_ID_HS, &bta_hf_client_reg) //注册到BTA
- bta_sys_sendmsg(BTA_HF_CLIENT_API_ENABLE_EVT)-->fixed_queue_enqueue(btu_bta_msg_queue)@bta_sys_main.c
}@bta_hf_client_api.c

//注册
btu_bta_msg_ready@btu_task.c-->bta_sys_event-->bta_sys_cb.reg[id]->evt_hdlr
@bta_sys_main.c-->bta_hf_client_reg.bta_hf_client_hdl_event@bta_hf_client_api.c-->
bta_hf_client_api_enable@bta_hf_client_main.c

//设置回调到bta_hf_client_cb.p_cback
bte_hf_client_evt-->
btif_hf_client_upstreams_evt{
- BTA_HF_CLIENT_OPEN_EVT{//连接
	- btif_hf_client_cb.state = BTHF_CLIENT_CONNECTION_STATE_CONNECTED
	- HAL_CBACK(bt_hf_client_callbacks, connection_state_cb)//回调
	}
- BTA_HF_CLIENT_IND_EVT:process_ind_evt{//电话状态
	- HAL_CBACK(bt_hf_client_callbacks, call_cb)
	- HAL_CBACK(bt_hf_client_callbacks, callsetup_cb
	}
- BTA_HF_CLIENT_AUDIO_OPEN_EVT://接听
	- HAL_CBACK(bt_hf_client_callbacks, audio_state_cb, BTHF_CLIENT_AUDIO_STATE_CONNECTED)
	
- BTA_HF_CLIENT_AUDIO_CLOSE_EVT://声音断开
	- HAL_CBACK(bt_hf_client_callbacks, audio_state_cb, BTHF_CLIENT_AUDIO_STATE_DISCONNECTED)

}@btif_hf_client.c


//连接事件上报

bta_hf_client_svc_conn_open-->bta_hf_client_cb.p_cback)(BTA_HF_CLIENT_CONN_EVT)@bta_hf_client_act.c
-->bte_hf_client_evt@btif_hf_client.c

btif/src/btif_hf_client.c
bta/hf_client/bta_hf_client_api.c
bta/hf_client/bta_hf_client_main.c
bta/sys/bta_sys_main.c
bta/hf_client/bta_hf_client_act.c
